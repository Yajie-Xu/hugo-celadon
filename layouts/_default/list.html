{{ define "main" }}
  <section class="listing-shell">
    <div class="listing-header">
      <h1 class="article-title">{{ .Title }}</h1>
      <div class="listing-description markdown-body">
        {{ .Content }}
      </div>
    </div>

    {{ $allTags := slice }}
    {{ range .Pages }}
      {{ with .Params.tags }}
        {{ $allTags = $allTags | append . }}
      {{ end }}
    {{ end }}
    {{ $uniqueTags := $allTags | uniq | sort }}
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all">All</button>
      {{ range $uniqueTags }}
        <button class="filter-btn" data-filter="{{ . | lower }}">{{ . }}</button>
      {{ end }}
    </div>

    <div class="listing-toolbar" role="group" aria-label="Choose layout">
      <button type="button" class="view-btn" data-view="view-card" aria-label="Card view">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
      </button>
      <button type="button" class="view-btn" data-view="view-list" aria-label="List view">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><circle cx="4" cy="6" r="1"></circle><circle cx="4" cy="12" r="1"></circle><circle cx="4" cy="18" r="1"></circle></svg>
      </button>
      <button type="button" class="view-btn" data-view="view-compact" aria-label="Compact view">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="5" height="5"></rect><rect x="10" y="4" width="5" height="5"></rect><rect x="17" y="4" width="4" height="5"></rect><rect x="3" y="11" width="4" height="5"></rect><rect x="9" y="11" width="4" height="5"></rect><rect x="15" y="11" width="6" height="5"></rect></svg>
      </button>
    </div>

    {{ $pages := .Pages.ByDate.Reverse }}
    <div id="listing-container" class="listing-grid view-card">
      {{ range $pages }}
        {{ $thumb := or .Params.thumbnail .Params.image "/images/profile.jpg" }}
        {{ $tags := .Params.tags | default (slice) }}
        <article class="listing-card" data-tags="{{ range $i, $tag := $tags }}{{ if $i }},{{ end }}{{ lower $tag }}{{ end }}">
          <div class="listing-thumb">
            <a href="{{ .RelPermalink }}">
              <img src="{{ $thumb | relURL }}" alt="{{ .Title }}" loading="lazy">
            </a>
          </div>

          <div class="card-body">
            <div class="listing-date">{{ .Date.Format "Jan 2, 2006" }}</div>
            
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
            
            {{ with .Summary }}
              <p class="summary">{{ . | truncate 120 }}</p>
            {{ end }}

            {{ with .Params.tags }}
            <div class="tag-row">
              {{ range . }}
                <span class="tag">#{{ . }}</span>
              {{ end }}
            </div>
            {{ end }}
          </div>
          
          <a href="{{ .RelPermalink }}" class="read-more-btn">Read â†’</a>
        </article>
      {{ end }}
    </div>
  </section>

  <script>
    (function () {
      const container = document.getElementById("listing-container");
      if (!container) return;
      const viewButtons = document.querySelectorAll(".view-btn");
      const filterButtons = document.querySelectorAll(".filter-btn");
      const cards = container.querySelectorAll(".listing-card");
      const storageKey = "listing-view-mode";

      const applyView = (mode) => {
        container.classList.remove("view-card", "view-list", "view-compact");
        container.classList.add(mode);
        viewButtons.forEach((btn) =>
          btn.classList.toggle("active", btn.dataset.view === mode)
        );
      };

      const storedView = localStorage.getItem(storageKey) || "view-card";
      applyView(storedView);

      viewButtons.forEach((btn) =>
        btn.addEventListener("click", () => {
          const mode = btn.dataset.view;
          applyView(mode);
          localStorage.setItem(storageKey, mode);
        })
      );

      const applyFilter = (filter) => {
        cards.forEach((card) => {
          const tags = card.dataset.tags ? card.dataset.tags.split(",") : [];
          const matches = filter === "all" || tags.includes(filter);
          card.classList.toggle("hidden", !matches);
        });
      };

      filterButtons.forEach((btn) =>
        btn.addEventListener("click", () => {
          const filter = btn.dataset.filter;
          filterButtons.forEach((button) =>
            button.classList.toggle("active", button === btn)
          );
          applyFilter(filter);
        })
      );

      applyFilter("all");
    })();
  </script>
{{ end }}
